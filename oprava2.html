<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Budovy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { background: #f5efe1; font-family: Arial, sans-serif; margin: 0; }
    header { background: #292e2c; color: #fff; padding: 14px 18px; display: flex; justify-content: space-between; align-items: center; }
    nav { display: flex; gap: 18px; }
    nav a { color: #fff; text-decoration: none; background: #4c4f4e; padding: 7px 18px; border-radius: 10px; font-weight: bold; }
    nav a:hover { background: #393b39; }
    .resources { display: flex; gap: 25px; padding: 14px 18px; background: #e5decf; border-bottom: 1px solid #ddd; align-items: center; }
    .resources span { font-weight: bold; }
    .tab-bar { margin: 24px 0 10px 0; text-align: center; }
    .tab-bar button { background: #ece9e0; border: 1px solid #d6cfc0; border-bottom: none; font-size: 18px; padding: 8px 32px; margin: 0 4px; border-radius: 10px 10px 0 0; cursor: pointer; font-weight: bold; }
    .tab-bar .active { background: #fff; border-bottom: 1px solid #fff; color: #2a2b29; }
    .tab-content { background: #fff; padding: 18px; border-radius: 0 0 12px 12px; margin: 0 0 26px 0; border: 1px solid #d6cfc0; min-height: 130px; }
    .building-card, .research-card { display: flex; gap: 14px; align-items: flex-start; background: #f5efe7; margin-bottom: 14px; padding: 12px 16px; border-radius: 10px; border: 1px solid #e5d6b8; box-shadow: 0 2px 4px #0001; }
    .building-card.inactive, .research-card.inactive { opacity: 0.6; filter: grayscale(0.5); }
    .icon { font-size: 2rem; min-width: 2.6rem; }
    .details { flex: 1; }
    .title { font-weight: bold; font-size: 1.1em; margin-bottom: 2px; }
    .level { font-size: 1em; color: #3d3e37; margin-bottom: 2px; }
    .timer { color: #aa7b3a; font-size: 0.95em; margin: 3px 0 2px 0; }
    .btn { background: #c09853; color: #fff; border: none; border-radius: 8px; padding: 7px 19px; font-size: 1em; font-weight: bold; cursor: pointer; margin: 0 0 0 5px; }
    .btn:disabled { background: #dfceac; color: #665e45; cursor: not-allowed; }
    .status { margin-top: 8px; color: #228b22; }
    @media (max-width: 600px) {
      .resources { flex-direction: column; gap: 8px; }
      .tab-content { padding: 6px; }
      .building-card, .research-card { flex-direction: column; }
    }
  </style>
</head>
<body>
<header>
  <div>Moje Vesnice - Budovy</div>
  <nav>
    <a href="index.html">Pole</a>
    <a href="buildings.html" style="background:#a28f69;">Budovy</a>
  </nav>
</header>
<div class="resources">
  <span>D≈ôevo: <span id="wood">0</span></span>
  <span>Hl√≠na: <span id="clay">0</span></span>
  <span>≈Ωelezo: <span id="iron">0</span></span>
  <span>Obil√≠: <span id="grain">0</span></span>
  <span>| Zlat√©: <span id="tokens">0</span></span>
  <button id="addTokensBtn" class="btn" style="padding:5px 12px;font-size:0.93em;">+</button>
</div>
<div class="tab-bar" id="tabs">
  <button class="active" data-tab="buildings">Budovy</button>
  <button data-tab="academy">Akademie</button>
</div>
<div id="tab-buildings" class="tab-content"></div>
<div id="tab-academy" class="tab-content" style="display:none;">
  <h2>Akademie - V√Ωzkum jednotek</h2>
  <div id="research-list"></div>
</div>
<div id="speedUpStatus" class="status"></div>

<script>
  // Data a utility (nezkraceno pro p≈ôehlednost, m≈Ø≈æe≈° to d√°l roz≈°i≈ôovat)
  let floatResources = { wood: 500, clay: 500, iron: 500, grain: 500 };
  let tokens = 100;
  const baseCap = 2000;
  const baseCostsBuildings = {
    main:   { wood: 100, clay: 80, iron: 90, grain: 70, time: 20 },
    granary:{ wood: 60, clay: 40, iron: 50, grain: 30, time: 10 },
    warehouse:{ wood: 70, clay: 50, iron: 60, grain: 40, time: 10 },
    barracks:{ wood: 150, clay: 130, iron: 120, grain: 110, time: 30 },
    rally:  { wood: 120, clay: 100, iron: 90, grain: 80, time: 25 },
    stable: { wood: 160, clay: 140, iron: 130, grain: 120, time: 35 },
    workshop:{ wood: 200, clay: 180, iron: 170, grain: 150, time: 40 },
    academy:{ wood: 220, clay: 200, iron: 180, grain: 170, time: 45 },
    market: { wood: 100, clay: 90, iron: 80, grain: 70, time: 15 },
  };
  const buildingsList = [
    { id: 'main', name: "Hlavn√≠ budova", icon: "üè∞" },
    { id: 'granary', name: "S√Ωpka", icon: "üåæ" },
    { id: 'warehouse', name: "Sklad", icon: "üè†" },
    { id: 'barracks', name: "Kas√°rna", icon: "ü™ñ" },
    { id: 'rally', name: "Shroma≈ædi≈°tƒõ", icon: "üõ°Ô∏è" },
    { id: 'stable', name: "St√°je", icon: "üê¥" },
    { id: 'workshop', name: "D√≠lna", icon: "üîß" },
    { id: 'academy', name: "Akademie", icon: "üéì" },
    { id: 'market', name: "Tr≈ænice", icon: "üè™" },
  ];
  // V√Ωzkum a jednotky ‚Äì m≈Ø≈æe≈° roz≈°√≠≈ôit!
  const unitsList = {
    barracks: [
      { id: 'palkar', name: 'Pƒõ≈°√°k (Palkar)', icon: 'üõ°Ô∏è', attack: 40, defense: 40, defInfantry:40, defCavalry:10, requiredBuildingLevel: 1, researched: true, trainingTime: 2, grainPerHour: 1 },
      { id: 'sekyrnik', name: 'Sekyrn√≠k', icon: 'ü™ì', attack: 60, defense: 60, defInfantry:40, defCavalry:40, requiredBuildingLevel: 3, researched: false, trainingTime: 3, grainPerHour: 1 },
      { id: 'ostepar', name: 'Ostepar', icon: 'ü¶µ', attack: 20, defense: 20, defInfantry:30, defCavalry:70, requiredBuildingLevel: 3, researched: false, trainingTime: 3, grainPerHour: 1 },
    ],
    stable: [
      { id: 'kun_tueton', name: 'K≈Ø≈à Tueton', icon: 'üê¥', attack: 120, defense: 120, defInfantry:60, defCavalry:70, requiredBuildingLevel: 10, researched: false, trainingTime: 5, grainPerHour: 2 },
      { id: 'ryt√≠≈ô', name: 'Ryt√≠≈ô', icon: 'üèá', attack: 70, defense: 110, defInfantry:70, defCavalry:70, requiredBuildingLevel: 10, researched: false, trainingTime: 6, grainPerHour: 2 },
    ],
  };
  const researchList = [
    { id: 'sekyrnik', name: 'V√Ωzkum Sekyrn√≠ka', time: 5, buildingReq: 5, buildingId: 'academy', unlocksUnit: 'sekyrnik' },
    { id: 'ostepar', name: 'V√Ωzkum Ostepara', time: 6, buildingReq: 5, buildingId: 'academy', unlocksUnit: 'ostepar' },
    { id: 'kun_tueton', name: 'V√Ωzkum K≈Ø≈à Tueton', time: 10, buildingReq: 10, buildingId: 'academy', unlocksUnit: 'kun_tueton' },
    { id: 'ryt√≠≈ô', name: 'V√Ωzkum Ryt√≠≈ôe', time: 12, buildingReq: 10, buildingId: 'academy', unlocksUnit: 'ryt√≠≈ô' },
  ];

  let buildingData = {};
  let researchData = {};
  let researchQueue = {};

  // Z√°kladn√≠ funkce pro naƒçten√≠/ulo≈æen√≠
  function saveGame() {
    localStorage.setItem('buildingData', JSON.stringify(buildingData));
    localStorage.setItem('researchData', JSON.stringify(researchData));
    localStorage.setItem('researchQueue', JSON.stringify(researchQueue));
    localStorage.setItem('tokens', tokens);
    localStorage.setItem('resources', JSON.stringify(floatResources));
  }
  function loadGame() {
    const bData = localStorage.getItem('buildingData');
    const rData = localStorage.getItem('researchData');
    const resData = localStorage.getItem('researchQueue');
    const rTokens = localStorage.getItem('tokens');
    const rRes = localStorage.getItem('resources');
    buildingData = bData ? JSON.parse(bData) : {};
    researchData = rData ? JSON.parse(rData) : {};
    researchQueue = resData ? JSON.parse(resData) : {};
    tokens = rTokens !== null ? parseInt(rTokens) : 100;
    floatResources = rRes ? JSON.parse(rRes) : { wood: 500, clay: 500, iron: 500, grain: 500 };
    // Inicializace budov
    buildingsList.forEach(b => {
      if (!buildingData[b.id]) buildingData[b.id] = { level: b.id === 'main' ? 1 : 0, built: b.id === 'main', upgrading: false, upgradeEnd: null };
    });
    // Inicializace v√Ωzkum≈Ø
    researchList.forEach(r => {
      if (researchData[r.id] === undefined) researchData[r.id] = false;
      if (!researchQueue[r.id]) researchQueue[r.id] = null;
    });
  }

  // U≈æivatelsk√© rozhran√≠
  function updateResourcesDisplay() {
    const warehouseLvl = buildingData.warehouse?.level || 0;
    const granaryLvl = buildingData.granary?.level || 0;
    const woodCap = baseCap + warehouseLvl * 2000;
    const clayCap = baseCap + warehouseLvl * 2000;
    const ironCap = baseCap + warehouseLvl * 2000;
    const grainCap = baseCap + granaryLvl * 2000;
    document.getElementById('wood').textContent = Math.floor(floatResources.wood) + ' / ' + woodCap;
    document.getElementById('clay').textContent = Math.floor(floatResources.clay) + ' / ' + clayCap;
    document.getElementById('iron').textContent = Math.floor(floatResources.iron) + ' / ' + ironCap;
    document.getElementById('grain').textContent = Math.floor(floatResources.grain) + ' / ' + grainCap;
  }
  function updateTokensDisplay() {
    document.getElementById('tokens').textContent = tokens;
  }

  // Form√°tov√°n√≠ ƒçasu
  function formatTime(ms) {
    if (ms <= 0) return "0:00";
    const totalSec = Math.ceil(ms / 1000);
    const min = Math.floor(totalSec / 60);
    const sec = totalSec % 60;
    return `${min}:${sec.toString().padStart(2,"0")}`;
  }
  function getSpeedMultiplier() {
    const lvl = buildingData.main ? buildingData.main.level : 1;
    return 1 + (lvl -1) * 0.1;
  }

  // Odemƒçen√≠ budovy (m≈Ø≈æe≈° d√°l roz≈°√≠≈ôit)
  function isUnlockedBuilding(id) {
    if (id === 'granary' || id === 'warehouse') return buildingData.main && buildingData.main.level >= 3;
    if (id === 'barracks') return buildingData.main && buildingData.main.level >= 5;
    if (id === 'academy') return buildingData.barracks && buildingData.barracks.level >= 3;
    if (id === 'stable') return buildingData.barracks && buildingData.barracks.level >= 5;
    return true;
  }
  function calculateBuildingCost(level, id) {
    const base = baseCostsBuildings[id];
    const multiplier = level + 1;
    return {
      wood: base.wood * multiplier,
      clay: base.clay * multiplier,
      iron: base.iron * multiplier,
      grain: base.grain * multiplier,
      time: base.time * multiplier
    };
  }
  // Vykreslen√≠ budov
  function renderBuildings() {
    const container = document.getElementById('tab-buildings');
    container.innerHTML = '<h2>Seznam budov</h2>';
    buildingsList.forEach(b => {
      const data = buildingData[b.id];
      const unlocked = isUnlockedBuilding(b.id);
      const div = document.createElement('div');
      div.className = 'building-card' + (unlocked ? '' : ' inactive');
      if (data && data.upgrading) div.classList.add('inactive');
      const icon = document.createElement('div');
      icon.className = 'icon'; icon.textContent = b.icon;
      const details = document.createElement('div');
      details.className = 'details';
      const title = document.createElement('div');
      title.className = 'title'; title.textContent = b.name;
      const level = document.createElement('div');
      level.className = 'level'; level.textContent = data && data.level > 0 ? `√örove≈à: ${data.level}` : "Nepostaveno";
      const btn = document.createElement('button');
      btn.className = 'btn';
      btn.textContent = data && data.upgrading ? "Upgraduje se..." : "Vylep≈°it";
      if (!unlocked) { div.classList.add('inactive'); btn.disabled = true; }
      else { div.classList.remove('inactive'); btn.disabled = false; }
      btn.onclick = () => startBuildingUpgrade(b.id);
      const timer = document.createElement('div');
      timer.className = 'timer';
      if (data && data.upgrading && data.upgradeEnd) {
        timer.textContent = "Zb√Ωv√°: " + formatTime(data.upgradeEnd - Date.now());
      }
      details.appendChild(title);
      details.appendChild(level);
      details.appendChild(btn);
      details.appendChild(timer);
      div.appendChild(icon);
      div.appendChild(details);
      container.appendChild(div);
    });
  }

  function startBuildingUpgrade(id) {
    const data = buildingData[id];
    if (data.upgrading) {
      if ((id === 'granary' || id === 'warehouse') && buildingData.main.level < 3) {
        alert("Mus√≠≈° m√≠t hlavn√≠ budovu na levelu 3.");
        return;
      }
      alert("Budova se ji≈æ vylep≈°uje.");
      return;
    }
    const cost = calculateBuildingCost(data.level, id);
    if (floatResources.wood < cost.wood || floatResources.clay < cost.clay || floatResources.iron < cost.iron || floatResources.grain < cost.grain) {
      alert("Nem√°≈° dostatek zdroj≈Ø na vylep≈°en√≠.");
      return;
    }
    floatResources.wood -= cost.wood; floatResources.clay -= cost.clay; floatResources.iron -= cost.iron; floatResources.grain -= cost.grain;
    updateResourcesDisplay();
    const speed = getSpeedMultiplier();
    const durationMs = (cost.time * 60 * 1000) / speed;
    data.upgrading = true;
    data.upgradeEnd = Date.now() + durationMs;
    saveGame();
    renderBuildings();
  }

  // Urychlen√≠ staveb za tokeny
function speedUpBuildings() {
  const now = Date.now();
  const upgradingBuildings = Object.entries(buildingData).filter(([id, b]) => b.upgrading && b.upgradeEnd > now);

  if (upgradingBuildings.length === 0) {
    alert("≈Ω√°dn√© prob√≠haj√≠c√≠ stavby k urychlen√≠.");
    return;
  }

  const costPerBuilding = 20;
  const totalCost = upgradingBuildings.length * costPerBuilding;

  if (tokens < totalCost) {
    alert(`Nem√°≈° dostatek token≈Ø. Pot≈ôebuje≈° ${totalCost} token≈Ø, m√°≈° ${tokens}.`);
    return;
  }

  tokens -= totalCost;

  // Dokonƒçit v≈°echny stavby najednou
  upgradingBuildings.forEach(([id, b]) => {
    b.level++;
    b.upgrading = false;
    b.upgradeEnd = null;
    b.built = true;
  });

  saveGame();
  renderBuildings();
  updateResourcesDisplay();
  updateTokensDisplay();

  const statusDiv = document.getElementById('speedUpStatus');
  statusDiv.textContent = `Urychleno ${upgradingBuildings.length} staveb za ${totalCost} token≈Ø.`;
  setTimeout(() => { statusDiv.textContent = ''; }, 5000);
}

// --- V√Ωzkum ---
function isResearchUnlocked(research) {
  const building = buildingData[research.buildingId];
  if (!building) return false;
  return building.level >= research.buildingReq;
}

function renderResearch() {
  const container = document.getElementById('research-list');
  container.innerHTML = '';
  researchList.forEach(r => {
    const unlocked = isResearchUnlocked(r);
    const researched = researchData[r.id] || false;
    const inProgress = researchQueue[r.id] && researchQueue[r.id] > Date.now();

    const div = document.createElement('div');
    div.className = 'research-card' + (unlocked ? '' : ' inactive');

    const icon = document.createElement('div');
    icon.className = 'icon';
    let unit = Object.values(unitsList).flat().find(u => u.id === r.unlocksUnit);
    icon.textContent = unit ? unit.icon : '‚ùì';

    const details = document.createElement('div');
    details.className = 'details';

    const title = document.createElement('div');
    title.className = 'title';
    title.textContent = r.name;

    const req = document.createElement('div');
    req.textContent = `Vy≈æaduje: Akademie level ${r.buildingReq}`;

    const status = document.createElement('div');
    status.className = 'timer';

    if (researched) {
      status.textContent = 'V√Ωzkum dokonƒçen';
    } else if (inProgress) {
      status.textContent = 'V√Ωzkum prob√≠h√°: ' + formatTime(researchQueue[r.id] - Date.now());
    } else if (!unlocked) {
      status.textContent = 'Zamƒçeno';
    } else {
      status.textContent = '';
    }

    const btn = document.createElement('button');
    btn.className = 'btn';
    btn.textContent = researched ? 'Dokonƒçeno' : (inProgress ? 'V√Ωzkum prob√≠h√°' : 'Zaƒç√≠t v√Ωzkum');
    btn.disabled = researched || inProgress || !unlocked;
    btn.onclick = () => startResearch(r.id);

    details.appendChild(title);
    details.appendChild(req);
    details.appendChild(status);
    details.appendChild(btn);

    div.appendChild(icon);
    div.appendChild(details);

    container.appendChild(div);
  });
}

function startResearch(researchId) {
  if (researchQueue[researchId] && researchQueue[researchId] > Date.now()) {
    alert('V√Ωzkum u≈æ prob√≠h√°.');
    return;
  }
  const r = researchList.find(r => r.id === researchId);
  if (!r) return;
  const speed = getSpeedMultiplier();
  const duration = (r.time * 60 * 1000) / speed;
  researchQueue[researchId] = Date.now() + duration;
  saveGame();
  renderResearch();
}

function processResearchQueue() {
  let changed = false;
  const now = Date.now();
  for (const researchId in researchQueue) {
    const endTime = researchQueue[researchId];
    if (endTime && endTime <= now) {
      researchData[researchId] = true;
      researchQueue[researchId] = null;
      changed = true;
    }
  }
  if (changed) {
    saveGame();
    renderResearch();
  }
}

// --- P≈ôep√≠n√°n√≠ z√°lo≈æek ---
const tabs = document.querySelectorAll('#tabs button');
let currentTab = 'buildings';

tabs.forEach(tab => {
  tab.addEventListener('click', () => {
    tabs.forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    currentTab = tab.dataset.tab;
    showTab(currentTab);
  });
});

function showTab(tab) {
  document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = 'none');
  const el = document.getElementById('tab-' + tab);
  if (el) el.style.display = 'block';

  if(tab === 'buildings') renderBuildings();
  if(tab === 'academy') renderResearch();
}

// --- Timery a inicializace ---
function updateTimers() {
  const now = Date.now();
  let buildingsChanged = false;

  for (const id in buildingData) {
    const b = buildingData[id];
    if (b.upgrading && b.upgradeEnd <= now) {
      b.level++;
      b.upgrading = false;
      b.upgradeEnd = null;
      if (!b.built) b.built = true;
      buildingsChanged = true;
    }
  }
  if (buildingsChanged) {
    saveGame();
    if(currentTab==='buildings') renderBuildings();
    updateResourcesDisplay();
  }
  // V√Ωzkumy
  processResearchQueue();
  // Aktualizace UI timer≈Ø dle aktu√°ln√≠ z√°lo≈æky
  if (currentTab === 'buildings') renderBuildings();
  if (currentTab === 'academy') renderResearch();
  updateTokensDisplay();
}

function init() {
  loadGame();
  updateResourcesDisplay();
  updateTokensDisplay();
  showTab(currentTab);

  setInterval(() => {
    updateTimers();
  }, 1000);
}
init();

// Zlat√© tlaƒç√≠tko (+)
window.addEventListener('DOMContentLoaded', function () {
  document.getElementById('addTokensBtn').addEventListener('click', function () {
    const enteredPassword = prompt("Zadej heslo pro p≈ôid√°n√≠ zlat√Ωch:");
    if (enteredPassword === '1111') {
      const additionalTokens = 100;
      tokens += additionalTokens;
      updateTokensDisplay();
      saveGame();
      alert(`P≈ôid√°no ${additionalTokens} zlat√Ωch! M√°te ${tokens} token≈Ø.`);
    } else {
      alert("‚ùå ≈†patn√© heslo. Zlato nebylo p≈ôid√°no.");
    }
  });
});

</script>
</body>
</html>
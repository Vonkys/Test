<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Vesnice - Karta Pole</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f4f1e6;
    }
    header {
      background-color: #333;
      color: white;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    nav a {
      color: white;
      text-decoration: none;
      margin: 0 10px;
      padding: 5px 10px;
      border-radius: 5px;
    }
    nav a:hover {
      background-color: #555;
    }
    .resources {
      display: flex;
      justify-content: space-around;
      background-color: #e8e4d8;
      padding: 10px;
      margin-top: 5px;
    }
    .field-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 40px 0 20px 0;
    }
    #fieldCircle {
      position: relative;
      width: 520px;
      height: 520px;
      border-radius: 50%;
      background: #faf9f6;
      margin: 0 auto;
      border: 2px solid #d3c7b7;
    }
    .field-icon {
      position: absolute;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #fffbe7;
      border: 1.5px solid #ceb18f;
      box-shadow: 0 2px 6px rgba(60,36,10,0.11);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      cursor: pointer;
      transition: box-shadow 0.2s;
      user-select: none;
      z-index: 1;
    }
    .field-icon:hover {
      box-shadow: 0 4px 12px rgba(150,90,20,0.13);
      background: #fff8db;
    }
    .field-level {
      font-size: 13px;
      color: #7d5b2e;
      font-weight: bold;
      margin-top: 3px;
      letter-spacing: 0.5px;
    }
    .field-timer {
      font-size: 11px;
      color: #ab3510;
      margin-top: 1px;
      font-weight: bold;
    }
    #upgradePopup {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #fffbe7;
      border: 2px solid #bbac9d;
      border-radius: 12px;
      box-shadow: 0 6px 24px rgba(70, 45, 11, 0.18);
      padding: 30px 30px 20px 30px;
      z-index: 20;
      display: none;
      min-width: 320px;
    }
    #upgradePopup h3 {
      margin-top: 0;
    }
    #upgradePopup .costs {
      display: flex;
      justify-content: space-between;
      margin: 12px 0 15px 0;
    }
    #upgradePopup .cost {
      font-size: 16px;
      color: #4b3621;
    }
    #upgradePopup .close-btn {
      position: absolute;
      top: 10px; right: 12px;
      background: #ead2ad;
      border: none;
      border-radius: 50%;
      width: 26px; height: 26px;
      cursor: pointer;
      font-weight: bold;
      font-size: 18px;
      color: #955a17;
    }
    #upgradePopup .close-btn:hover {
      background: #ffe0a1;
    }
    .upgrade-btn {
      padding: 8px 22px;
      border: none;
      background: #b1976b;
      color: #fff;
      font-weight: bold;
      border-radius: 8px;
      font-size: 15px;
      cursor: pointer;
      margin-right: 10px;
      margin-top: 7px;
    }
    .upgrade-btn:disabled {
      background: #ccc2b3;
      color: #726451;
      cursor: not-allowed;
    }
    .production-row {
      display: flex;
      justify-content: space-around;
      background: #f7ecd1;
      border: 1px solid #e2d3ba;
      border-radius: 8px;
      margin: 8px 10px;
      padding: 7px;
      font-size: 15px;
      color: #6c5733;
    }
    .token-bar {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 12px 0 3px 0;
    }
    .token-icon {
      font-size: 1.35em;
      margin-right: 6px;
    }
    #speedUpBtn {
      margin-left: 18px;
      background: #f7be38;
      color: #875a0e;
      border: none;
      padding: 7px 17px;
      border-radius: 7px;
      font-weight: bold;
      cursor: pointer;
      font-size: 15px;
      box-shadow: 0 2px 6px rgba(150,90,20,0.07);
      transition: background 0.15s;
    }
    #speedUpBtn:disabled {
      background: #e9ddaf;
      color: #b7a46c;
      cursor: not-allowed;
    }
    #upgradesUl {
      padding-left: 20px;
      font-size: 15px;
      color: #7a5b2d;
    }
  </style>
</head>
<body>
  <header>
    <div>Travian Klon ‚Äì Karta Pole</div>
    <nav>
      <a href="index.html">Pole</a>
      <a href="buildings.html">Budovy</a>
      <!-- p≈ôidej dal≈°√≠ z√°lo≈æky -->
    </nav>
  </header>
  <div class="resources">
    <div>D≈ôevo: <span id="wood"></span></div>
    <div>Hl√≠na: <span id="clay"></span></div>
    <div>≈Ωelezo: <span id="iron"></span></div>
    <div>Obil√≠: <span id="grain"></span></div>
  </div>
  <div class="production-row">
    <div>+<span id="woodRate"></span>/h</div>
    <div>+<span id="clayRate"></span>/h</div>
    <div>+<span id="ironRate"></span>/h</div>
    <div>+<span id="grainRate"></span>/h</div>
  </div>
  <div class="token-bar">
    <span class="token-icon">üü°</span> <span id="tokens"></span>
    <button id="addTokensBtn">P≈ôidat zlato</button>
    <button id="speedUpBtn" onclick="speedUpUpgrades()">Urychlit stavby (10 zlata)</button>
  </div>
  <div class="field-container">
    <div id="fieldCircle"></div>
  </div>
  <div>
    <h3>Prob√≠haj√≠c√≠ vylep≈°en√≠:</h3>
    <ul id="upgradesUl"></ul>
  </div>
  <!-- Popup pro vylep≈°en√≠ pole -->
  <div id="upgradePopup">
    <button class="close-btn" onclick="closeUpgradePopup()">√ó</button>
    <h3>Vylep≈°it pole</h3>
    <div>Aktu√°ln√≠ √∫rove≈à: <span id="currentLevel"></span></div>
    <div class="costs">
      <div class="cost">D≈ôevo: <span id="costWood"></span></div>
      <div class="cost">Hl√≠na: <span id="costClay"></span></div>
      <div class="cost">≈Ωelezo: <span id="costIron"></span></div>
      <div class="cost">Obil√≠: <span id="costGrain"></span></div>
    </div>
    <p id="upgradeStatus"></p>
    <button id="upgradeButton" class="upgrade-btn" onclick="startUpgrade()">Vylep≈°it</button>
  </div>
<script>
  // Data a promƒõnn√©
  const production = { wood: 0, clay: 0, iron: 0, grain: 0 };
  const productionByLevel = {
    1: 0, 2: 50, 3: 150, 4: 300, 5: 500, 6: 800, 7: 1200, 8: 1700, 9: 2300, 10: 3000
  };
  let resources = { wood: 2000, clay: 2000, iron: 2000, grain: 2000 };
  let floatResources = { ...resources };
  let fields = [];
  const types = ["üå≤", "üß±", "‚õèÔ∏è", "üåæ"];
  const fieldTypes = ["wood", "clay", "iron", "grain"];
  let fieldsData = null;
  let currentUpgradeIndex = null;
  let tokens = 300;
  let upgradedThisTick = new Set();

  function formatTime(ms) {
    if (ms <= 0) return "";
    const totalSec = Math.ceil(ms / 1000);
    const min = Math.floor(totalSec / 60);
    const sec = totalSec % 60;
    return `${min}:${sec.toString().padStart(2, "0")}`;
  }

  function upgradeDuration(currentLevel) {
    const targetLevel = currentLevel + 1;
    if (targetLevel <= 1) return 0;
    if (targetLevel >= 10) return 2 * 60 * 60 * 1000;
    return 60 * 1000 + ((targetLevel - 2) / (10 - 2)) * (2 * 60 * 60 * 1000 - 60 * 1000);
  }

  function saveGame() {
    localStorage.setItem("resources", JSON.stringify(floatResources));
    localStorage.setItem("fields", JSON.stringify(fieldsData));
    localStorage.setItem("tokens", tokens);
    localStorage.setItem('lastVisit', Date.now());
  }

  function loadGame() {
    const savedResources = localStorage.getItem("resources");
    const savedFields = localStorage.getItem("fields");
    const savedTokens = localStorage.getItem("tokens");

    if (savedResources) {
      floatResources = JSON.parse(savedResources);
    }

    // --- OPRAVA, ABY V≈ΩDY BYLA POLE SPR√ÅVNƒö ---
    if (savedFields) {
      fieldsData = JSON.parse(savedFields);
      // Oprava chybƒõj√≠c√≠ch nebo rozbit√Ωch pol√≠
      for (let i = 0; i < 20; i++) {
        if (!fieldsData[i] || !fieldsData[i].type) {
          let type;
          if (i < 4) type = "wood";
          else if (i < 8) type = "clay";
          else if (i < 12) type = "iron";
          else type = "grain";
          fieldsData[i] = { type, level: 1, upgradeEndTime: null };
        }
      }
    } else {
      fieldsData = Array(20)
        .fill(null)
        .map((_, i) => {
          let type;
          if (i < 4) type = "wood";
          else if (i < 8) type = "clay";
          else if (i < 12) type = "iron";
          else type = "grain";
          return { type, level: 1, upgradeEndTime: null };
        });
    }

    if (savedTokens !== null) {
      tokens = parseInt(savedTokens);
    } else {
      tokens = 300;
    }

    // --- OFFLINE PRODUKCE ---
    const lastVisit = parseInt(localStorage.getItem('lastVisit') || Date.now());
    const now = Date.now();
    const secondsPassed = Math.floor((now - lastVisit) / 1000);

    if (fieldsData && typeof productionByLevel !== "undefined") {
      let offlineProduction = { wood: 0, clay: 0, iron: 0, grain: 0 };
      for (const data of fieldsData) {
        offlineProduction[data.type] += productionByLevel[data.level] || 0;
      }

      floatResources.wood += offlineProduction.wood * (secondsPassed / 3600);
      floatResources.clay += offlineProduction.clay * (secondsPassed / 3600);
      floatResources.iron += offlineProduction.iron * (secondsPassed / 3600);
      floatResources.grain += offlineProduction.grain * (secondsPassed / 3600);
    }
    // -------------------------

    resources = {
      wood: Math.floor(floatResources.wood),
      clay: Math.floor(floatResources.clay),
      iron: Math.floor(floatResources.iron),
      grain: Math.floor(floatResources.grain),
    };

    updateResources();
    updateTokensDisplay();
  }

  function createFields() {
    const fieldCircle = document.getElementById("fieldCircle");
    const total = 20;
    const radius = 250;
    for (let i = 0; i < total; i++) {
      const icon = document.createElement("div");
      icon.className = "field-icon";
      const angle = (360 / total) * i;
      const radians = (angle * Math.PI) / 180;
      const x = Math.cos(radians) * radius;
      const y = Math.sin(radians) * radius;
      icon.style.left = `calc(50% + ${x}px - 30px)`;
      icon.style.top = `calc(50% + ${y}px - 30px)`;
      icon.dataset.index = i;
      icon.onclick = () => showUpgradePopup(fields[i]);
      fieldCircle.appendChild(icon);
      fields.push(icon);
    }
  }

  function updateFieldIcons() {
    for (let i = 0; i < fields.length; i++) {
      const field = fields[i];
      const data = fieldsData[i];
      // Ochrana proti chybƒõ
      if (!data || !data.type) {
        field.textContent = "?";
        continue;
      }
      const typeIndex = fieldTypes.indexOf(data.type);
      field.textContent = types[typeIndex] || "?";
      let lvlDiv = field.querySelector(".field-level");
      if (!lvlDiv) {
        lvlDiv = document.createElement("div");
        lvlDiv.className = "field-level";
        field.appendChild(lvlDiv);
      }
      lvlDiv.textContent = "Lvl " + data.level;
      let timerDiv = field.querySelector(".field-timer");
      if (!timerDiv) {
        timerDiv = document.createElement("div");
        timerDiv.className = "field-timer";
        field.appendChild(timerDiv);
      }
      if (data.upgradeEndTime && Date.now() < data.upgradeEndTime) {
        const remaining = data.upgradeEndTime - Date.now();
        timerDiv.textContent = formatTime(remaining);
        field.style.opacity = "0.6";
      } else {
        timerDiv.textContent = "";
        field.style.opacity = "1";
      }
    }
  }

  function calculateCost(level, type) {
    const cost = { wood: 0, clay: 0, iron: 0, grain: 0 };
    switch (type) {
      case "wood":
        cost.wood = 40 * level;
        cost.clay = 100 * level;
        cost.iron = 110 * level;
        cost.grain = 30 * level;
        break;
      case "clay":
        cost.wood = 100 * level;
        cost.clay = 40 * level;
        cost.iron = 110 * level;
        cost.grain = 30 * level;
        break;
      case "iron":
        cost.wood = 100 * level;
        cost.clay = 110 * level;
        cost.iron = 40 * level;
        cost.grain = 30 * level;
        break;
      case "grain":
        cost.wood = 100 * level;
        cost.clay = 100 * level;
        cost.iron = 100 * level;
        cost.grain = 10 * level;
        break;
    }
    return cost;
  }

  function showUpgradePopup(field) {
    const i = parseInt(field.dataset.index);
    currentUpgradeIndex = i;
    const data = fieldsData[i];
    const level = data.level;
    const type = data.type;
    const cost = calculateCost(level, type);
    document.getElementById("currentLevel").innerText = level;
    document.getElementById("costWood").innerText = cost.wood;
    document.getElementById("costClay").innerText = cost.clay;
    document.getElementById("costIron").innerText = cost.iron;
    document.getElementById("costGrain").innerText = cost.grain;
    updateUpgradePopupTimer();
    const popup = document.getElementById("upgradePopup");
    popup.style.display = "block";
  }

  function updateUpgradePopupTimer() {
    if (currentUpgradeIndex === null) return;
    const data = fieldsData[currentUpgradeIndex];
    const upgradeBtn = document.getElementById("upgradeButton");
    const statusP = document.getElementById("upgradeStatus");
    if (data.upgradeEndTime && Date.now() < data.upgradeEndTime) {
      upgradeBtn.disabled = true;
      upgradeBtn.textContent = "Vylep≈°en√≠ prob√≠h√°...";
      const remaining = data.upgradeEndTime - Date.now();
      statusP.textContent = `Zb√Ωv√°: ${formatTime(remaining)}`;
    } else {
      upgradeBtn.disabled = false;
      upgradeBtn.textContent = "Vylep≈°it";
      statusP.textContent = "";
    }
  }

  function closeUpgradePopup() {
    document.getElementById("upgradePopup").style.display = "none";
    currentUpgradeIndex = null;
  }

  function startUpgrade() {
    if (currentUpgradeIndex === null) return;
    const data = fieldsData[currentUpgradeIndex];
    if (data.upgradeEndTime && Date.now() < data.upgradeEndTime) {
      alert("Toto pole u≈æ se vylep≈°uje!");
      return;
    }
    // Zjisti kolik pol√≠ se pr√°vƒõ vylep≈°uje
    const activeUpgrades = fieldsData.filter(f => f.upgradeEndTime && Date.now() < f.upgradeEndTime).length;
    if (activeUpgrades >= 3) {
      alert("M≈Ø≈æe≈° m√≠t pouze 3 souƒçasn√© upgrady pol√≠!");
      return;
    }
    const cost = calculateCost(data.level, data.type);
    if (
      floatResources.wood >= cost.wood &&
      floatResources.clay >= cost.clay &&
      floatResources.iron >= cost.iron &&
      floatResources.grain >= cost.grain
    ) {
      floatResources.wood -= cost.wood;
      floatResources.clay -= cost.clay;
      floatResources.iron -= cost.iron;
      floatResources.grain -= cost.grain;

      resources.wood = Math.floor(floatResources.wood);
      resources.clay = Math.floor(floatResources.clay);
      resources.iron = Math.floor(floatResources.iron);
      resources.grain = Math.floor(floatResources.grain);

      const duration = upgradeDuration(data.level);
      data.upgradeEndTime = Date.now() + duration;

      updateResources();
      updateFieldIcons();
      saveGame();
      closeUpgradePopup();
    } else {
      alert("Nem√°≈° dostatek zdroj≈Ø pro vylep≈°en√≠.");
    }
  }

  function updateResources() {
    resources.wood = Math.floor(floatResources.wood);
    resources.clay = Math.floor(floatResources.clay);
    resources.iron = Math.floor(floatResources.iron);
    resources.grain = Math.floor(floatResources.grain);
    document.getElementById("wood").innerText = resources.wood;
    document.getElementById("clay").innerText = resources.clay;
    document.getElementById("iron").innerText = resources.iron;
    document.getElementById("grain").innerText = resources.grain;
  }

  function updateProduction() {
    production.wood = 0;
    production.clay = 0;
    production.iron = 0;
    production.grain = 0;
    for (const data of fieldsData) {
      production[data.type] += productionByLevel[data.level] || 0;
    }
    document.getElementById("woodRate").innerText = production.wood;
    document.getElementById("clayRate").innerText = production.clay;
    document.getElementById("ironRate").innerText = production.iron;
    document.getElementById("grainRate").innerText = production.grain;
  }

  // Aktualizuje seznam prob√≠haj√≠c√≠ch upgrade≈Ø dole
  function updateUpgradeList() {
    const ul = document.getElementById("upgradesUl");
    ul.innerHTML = "";
    const now = Date.now();
    let anyUpgrades = false;
    for (let i = 0; i < fieldsData.length; i++) {
      const data = fieldsData[i];
      if (data.upgradeEndTime && data.upgradeEndTime > now) {
        anyUpgrades = true;
        const remaining = data.upgradeEndTime - now;
        const li = document.createElement("li");
        li.textContent = `Pole ${i + 1} (${data.type}) - lvl ${data.level} ‚Üí ${data.level + 1}, zb√Ωv√° ${formatTime(remaining)}`;
        ul.appendChild(li);
      }
    }
    if (!anyUpgrades) {
      const li = document.createElement("li");
      li.textContent = "≈Ω√°dn√° prob√≠haj√≠c√≠ vylep≈°en√≠.";
      ul.appendChild(li);
    }
  }

  // Tlaƒç√≠tka zlato a urychlen√≠
  function updateTokensDisplay() {
    if (document.getElementById("tokens")) {
      document.getElementById("tokens").innerText = tokens;
    }
  }

  // Urychl√≠ v≈°echny upgrady o polovinu ƒçasu za 10 token≈Ø
  function speedUpUpgrades() {
    if (tokens < 10) {
      alert("Nem√°≈° dostatek token≈Ø na urychlen√≠.");
      return;
    }
    const now = Date.now();
    let anyUpgraded = false;
    for (const data of fieldsData) {
      if (data.upgradeEndTime && data.upgradeEndTime > now) {
        const remaining = data.upgradeEndTime - now;
        data.upgradeEndTime = now + Math.floor(remaining / 2);
        anyUpgraded = true;
      }
    }
    if (anyUpgraded) {
      tokens -= 10;
      updateTokensDisplay();
      saveGame();
      updateUpgradeList();
      updateFieldIcons();
      alert("V≈°echny upgrady byly urychleny o polovinu ƒçasu.");
    } else {
      alert("≈Ω√°dn√© upgrady k urychlen√≠.");
    }
  }

  setInterval(() => {
    floatResources.wood += production.wood / 3600;
    floatResources.clay += production.clay / 3600;
    floatResources.iron += production.iron / 3600;
    floatResources.grain += production.grain / 3600;

    let changed = false;
    for (let i = 0; i < fieldsData.length; i++) {
      const data = fieldsData[i];
      if (
        data.upgradeEndTime &&
        Date.now() >= data.upgradeEndTime &&
        !upgradedThisTick.has(i)
      ) {
        data.level++;
        data.upgradeEndTime = null;
        upgradedThisTick.add(i);
        changed = true;
      }
    }
    if (changed) {
      updateProduction();
      updateFieldIcons();
      saveGame();
    }

    upgradedThisTick.clear();

    updateResources();
    updateFieldIcons();
    updateUpgradePopupTimer();
    updateUpgradeList();
    saveGame();
  }, 1000);

  window.addEventListener('DOMContentLoaded', function () {
    document.getElementById('addTokensBtn').addEventListener('click', function () {
      const enteredPassword = prompt("Zadej heslo pro p≈ôid√°n√≠ zlat√Ωch:");
      if (enteredPassword === '1111') {
        const additionalTokens = 100;
        tokens += additionalTokens;
        updateTokensDisplay();
        alert(`P≈ôid√°no ${additionalTokens} zlat√Ωch! M√°te ${tokens} token≈Ø.`);
      } else {
        alert("‚ùå ≈†patn√© heslo. Zlato nebylo p≈ôid√°no.");
      }
    });
  });

  // Inicializace
  loadGame();
  createFields();
  updateProduction();
  updateFieldIcons();
  updateResources();
  updateUpgradeList();
  updateTokensDisplay();

</script>
</body>
</html>